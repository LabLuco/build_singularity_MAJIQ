# SEE POST-IT FOR MAJ
BootStrap: debootstrap
OSVersion: stable
MirrorURL: http://ftp.us.debian.org/debian/

%runscript
    echo $PATH
    ls /root/
    python3.8 --version
    java --version
    cutadapt --version
    fastqc --version
    trim_galore --version
    /root/star/STAR-2.7.7a/source/STAR --version
    salmon --version
    snakemake --version
    majiq --version

%post
    apt update
    apt-get -y install unzip curl bzip2 git

    mkdir softwares
    cd softwares

    mkdir python3.8
    cd python3.8
    apt-get -y install build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev libbz2-dev
    curl -O https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tar.xz
    tar -xf Python-3.8.2.tar.xz
    rm -r Python-3.8.2.tar.xz
    cd Python-3.8.2
    ./configure --enable-optimizations
    make -j 4
    make altinstall

    apt-get -y install default-jdk

    mkdir ../fastqc
    cd ../fastqc
    curl https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v0.11.9.zip -o fastqc_v0.11.9.zip
    unzip fastqc_v0.11.9.zip
    rm -r fastqc_v0.11.9.zip

    python3.8 -m pip install --user --upgrade cutadapt

    python3.8 -m pip install --user --upgrade snakemake

    mkdir ../trimgalore
    cd ../trimgalore
    curl -fsSL https://github.com/FelixKrueger/TrimGalore/archive/0.6.6.tar.gz -o trim_galore.tar.gz
    tar xvzf trim_galore.tar.gz
    rm -r trim_galore.tar.gz

    mkdir ../salmon
    cd ../salmon
    curl -fsSL https://github.com/COMBINE-lab/salmon/releases/download/v1.4.0/salmon-1.4.0_linux_x86_64.tar.gz -o salmon-1.4.0_linux_x86_64.tar.gz
    tar xzvf salmon-1.4.0_linux_x86_64.tar.gz
    rm -r salmon-1.4.0_linux_x86_64.tar.gz

    mkdir ../star
    cd ../star
    curl -fsSL https://github.com/alexdobin/STAR/archive/2.6.1a.tar.gz -o 2.6.1a.tar.gz
    tar xvzf 2.6.1a.tar.gz
    rm -r 2.6.1a.tar.gz
    cd STAR-2.6.1a/source
    make STAR

    apt-get -y install autoconf automake make gcc perl zlib1g-dev libbz2-dev liblzma-dev libcurl4-gnutls-dev libssl-dev libncurses5-dev
    mkdir ../samtools
    cd ../samtools
    curl -fsSL https://github.com/samtools/samtools/releases/download/1.3.1/samtools-1.3.1.tar.bz2 -o samtools-1.3.1.tar.bz2
    tar -xvjf samtools-1.3.1.tar.bz2
    cd samtools-1.3.1
    make
    make prefix=/usr/local/bin install

    cd ../
    git clone https://github.com/LabLuco/snakemake_align_MAJIQ.git

    chmod 777 /root/
    chmod 777 /root/softwares/
    chmod 777 /root/softwares/fastqc/FastQC/fastqc
    chmod 777 /root/softwares/trimgalore/TrimGalore-0.6.6/trim_galore
    chmod 777 /root/softwares/salmon/salmon-latest_linux_x86_64/bin/salmon
    chmod 777 /root/.local/bin/cutadapt
    chmod 777 /root/.local/bin/snakemake

    cd ../
    apt-get -y install libhts2 libhts-dev 
    python3.8 -m venv env-majiq
    . env-majiq/bin/activate
    python3.8 -m pip install --user git+https://bitbucket.org/biociphers/majiq_academic.git#egg=majiq

    echo '. env-majiq/bin/activate' >> $SINGULARITY_ENVIRONMENT
    # echo '. env-majiq/bin/majiq' >> $SINGULARITY_ENVIRONMENT
    # echo '. env-majiq/bin/voila' >> $SINGULARITY_ENVIRONMENT

%environment
    PATH="/root/softwares/fastqc/FastQC/:$PATH"
    PATH="/root/softwares/trimgalore/TrimGalore-0.6.6/:$PATH"
    PATH="/root/softwares/salmon/salmon-latest_linux_x86_64/bin/:$PATH"
    PATH="/root/softwares/star/STAR-2.6.1a/source/:$PATH"
    PATH="/root/softwares/samtools/samtools-1.3.1/:$PATH"
    PATH="/root/.local/bin/:$PATH"
