# SEE POST-IT FOR MAJ
BootStrap: debootstrap
OSVersion: focal
MirrorURL: http://us.archive.ubuntu.com/ubuntu/

%runscript
    ls /root/
    echo $PATH
    pwd
    python3.8 --version
    java --version
    cutadapt --version
    fastqc --version
    trim_galore --version
    /root/star/STAR-2.7.7a/source/STAR --version
    salmon --version
    snakemake --version
    majiq --version

%post
    apt-get -y install software-properties-common
    add-apt-repository universe
    apt update
    apt-get -y install unzip curl bzip2 git
    
    apt-get -y install python3-pip

    ls /usr/bin/python*

    update-alternatives --install /usr/bin/python python /usr/bin/python3.8 2

    mkdir softwares
    cd softwares
    pwd

    # mkdir python3.8
    # cd python3.8
    # apt-get -y install build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev libbz2-dev
    # curl -O https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tar.xz
    # tar -xf Python-3.8.2.tar.xz
    # rm -r Python-3.8.2.tar.xz
    # cd Python-3.8.2
    # ./configure --enable-optimizations
    # make -j 4
    # make altinstall

    apt-get -y install default-jdk

    pwd
    mkdir fastqc
    cd fastqc
    curl https://www.bioinformatics.babraham.ac.uk/projects/fastqc/fastqc_v0.11.9.zip -o fastqc_v0.11.9.zip
    unzip fastqc_v0.11.9.zip
    rm -r fastqc_v0.11.9.zip

    python -m pip install --user --upgrade cutadapt

    python -m pip install --user --upgrade snakemake

    cd ../
    mkdir trimgalore
    cd trimgalore
    curl -fsSL https://github.com/FelixKrueger/TrimGalore/archive/0.6.6.tar.gz -o trim_galore.tar.gz
    tar xvzf trim_galore.tar.gz
    rm -r trim_galore.tar.gz

    # pwd
    # cd ../
    # mkdir salmon
    # cd salmon
    # curl -fsSL https://github.com/COMBINE-lab/salmon/releases/download/v1.4.0/salmon-1.4.0_linux_x86_64.tar.gz -o salmon-1.4.0_linux_x86_64.tar.gz
    # tar xzvf salmon-1.4.0_linux_x86_64.tar.gz
    # rm -r salmon-1.4.0_linux_x86_64.tar.gz

    apt-get -y install binutils zlib1g-dev
    cd ../
    mkdir star
    cd star
    curl -fsSL https://github.com/alexdobin/STAR/archive/2.6.1a.tar.gz -o 2.6.1a.tar.gz
    tar xvzf 2.6.1a.tar.gz
    rm -r 2.6.1a.tar.gz
    cd STAR-2.6.1a/source
    make STAR

    pwd
    apt-get -y install autoconf automake make gcc perl libbz2-dev liblzma-dev libcurl4-gnutls-dev libssl-dev libncurses5-dev libhts3 libhts-dev clang
    cd ../../
    mkdir samtools
    cd samtools
    curl -fsSL https://github.com/samtools/samtools/releases/download/1.3.1/samtools-1.3.1.tar.bz2 -o samtools-1.3.1.tar.bz2
    tar -xvjf samtools-1.3.1.tar.bz2
    cd samtools-1.3.1
    make
    make prefix=/usr/local/bin install

    cd ../../
    git clone https://github.com/LabLuco/snakemake_align_MAJIQ.git

    # python -m venv env-majiq
    # . env-majiq/bin/activate
    git clone https://bitbucket.org/biociphers/majiq_academic.git
    cd majiq_academic
    python -m pip install -r requirements.txt
    python setup.py install
    # python -m pip install --user git+https://bitbucket.org/biociphers/majiq_academic.git#egg=majiq

    # echo '. env-majiq/bin/activate' >> $SINGULARITY_ENVIRONMENT
    # echo '. env-majiq/bin/majiq' >> $SINGULARITY_ENVIRONMENT
    # echo '. env-majiq/bin/voila' >> $SINGULARITY_ENVIRONMENT
    pwd
    majiq -v

    # ADD BAMTOOLS TO GET TPMCalculator

    chmod 777 /root/
    chmod 777 /softwares/
    chmod 777 /softwares/fastqc/FastQC/fastqc
    chmod 777 /softwares/trimgalore/TrimGalore-0.6.6/trim_galore
    chmod 777 /softwares/salmon/salmon-latest_linux_x86_64/bin/salmon
    chmod 777 /root/.local/bin/cutadapt
    chmod 777 /root/.local/bin/snakemake

%environment
    PATH="/softwares/fastqc/FastQC/:$PATH"
    PATH="/softwares/trimgalore/TrimGalore-0.6.6/:$PATH"
    PATH="/softwares/salmon/salmon-latest_linux_x86_64/bin/:$PATH"
    PATH="/softwares/star/STAR-2.6.1a/source/:$PATH"
    PATH="/softwares/samtools/samtools-1.3.1/:$PATH"
    # PATH="/root/env-majiq/bin/:$PATH"
    PATH="/root/.local/bin/:$PATH"

